# Installation
install:
	@echo "ðŸ“¦ Installing server dependencies..."
	uv sync

# Linting
lint:
	@echo "ðŸ” Linting server..."
	@echo "ðŸŽ¨ Auto-formatting server..."
	VIRTUAL_ENV= uv run black . --exclude '\.venv'
	VIRTUAL_ENV= uv run isort . --skip-glob '.venv/*'
	VIRTUAL_ENV= uv run ruff check . --exclude .venv
	VIRTUAL_ENV= uv run mypy . --exclude '^(\.venv|playground)'
	VIRTUAL_ENV= uv run python ../linter/check_inline_imports.py --target-dir . --exclude playground
	@echo "âœ… Linting complete"

# Testing
test:
	@echo "ðŸ§ª Running server tests..."
	VIRTUAL_ENV= uv run python -m pytest tests
	@echo "âœ… Tests complete"

# Development server
dev: migrate gen-api-types
	@echo "ðŸš€ Starting server development server with DEBUG logging..."
	VIRTUAL_ENV= LOG_LEVEL=DEBUG uv run -m uvicorn app.main:app --reload

# OpenAPI export
export-openapi:
	@echo "ðŸ“ Exporting OpenAPI schema..."
	VIRTUAL_ENV= uv run export_openapi.py > openapi.json

# Fake RunPod server for local validation
fake-runpod:
	@echo "ðŸŽ­ Starting fake RunPod server..."
	VIRTUAL_ENV= PYTHONPATH=../research_pipeline:..:$(PYTHONPATH) uv run python -m app.services.research_pipeline.fake_runpod_server

# Generate API types for frontend
gen-api-types: export-openapi
	@echo "ðŸ§¬ Generating frontend API types from OpenAPI schema..."
	cd ../frontend && npx openapi-typescript ../server/openapi.json --output src/types/api.gen.ts

# Database migrations
migrate:
	@echo "ðŸ“Š Running database migrations..."
	VIRTUAL_ENV= uv run migrate.py upgrade

.PHONY: install lint test dev export-openapi gen-api-types migrate fake-runpod

