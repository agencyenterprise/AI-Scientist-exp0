{
  "id": "conversation-status-tracking",
  "name": "Conversation Status Tracking",
  "description": "Add status column to conversations table (Draft | With Research) with auto-update when research runs are created, and Edit buttons in IdeationQueueCard and InlineIdeaView to navigate to /conversation/[id] page",
  "created": "2025-12-08T00:00:00Z",
  "lastUpdated": "2025-12-08T21:00:00Z",
  "classification": {
    "type": "fullstack",
    "scope": "single-feature",
    "complexity": "moderate",
    "confidence": "high",
    "requiresUserStories": false,
    "workflow": [
      "feature-planner",
      "codebase-analyzer",
      "feature-architecture-expert",
      "fastapi-expert",
      "nextjs-expert",
      "feature-executor",
      "documentation-reviewer"
    ],
    "reasoning": {
      "type": "User story describes both backend (status column + database migration + auto-update) and frontend (UI updates to 2 components)",
      "scope": "Changes limited to conversation feature - backend schema, service updates, API changes, and 2 frontend components",
      "complexity": "Moderate - requires database migration, backend status update logic, API changes, and coordinated frontend updates",
      "requiresUserStories": "False - file-driven approach is sufficient. While fullstack and user-facing, the scope is contained to a single feature with clear technical requirements (status enum + edit buttons).",
      "workflow": "Full workflow needed due to fullstack nature: database schema changes (migration), backend API updates (FastAPI), frontend component modifications (Next.js), and documentation"
    }
  },
  "techStack": {
    "detected": [
      "nextjs-15",
      "typescript",
      "react-19",
      "fastapi",
      "postgresql",
      "alembic"
    ],
    "versions": {
      "next": "15.4.8",
      "react": "19.1.2",
      "fastapi": "0.115.0",
      "typescript": "5.x"
    }
  },
  "docsConsulted": {
    "project": [
      ".agent/README.md",
      ".agent/System/project_architecture.md",
      ".agent/System/server_architecture.md",
      ".agent/System/frontend_architecture.md",
      ".agent/SOP/server_database_migrations.md"
    ],
    "external": [],
    "existingFeatures": [
      "server/app/models/conversations.py",
      "server/app/api/conversations.py",
      "server/app/services/database/conversations.py",
      "server/app/services/database/research_pipeline_runs.py",
      "server/app/services/database/ideas.py",
      "server/app/services/database/__init__.py",
      "server/database_migrations/versions/0003_manual_seed_columns.py",
      "server/database_migrations/versions/0012_substage_completed_events.py",
      "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
      "frontend/src/features/conversation/components/InlineIdeaView.tsx",
      "frontend/src/features/conversation/types/ideation-queue.types.ts"
    ]
  },
  "assets": {
    "reuse": [
      {
        "name": "Button",
        "path": "@/shared/components/ui/button",
        "reason": "shadcn Button component - use variant='ghost' for Edit button",
        "usedIn": [],
        "patterns": {
          "variants": ["default", "destructive", "outline", "secondary", "ghost", "link"],
          "sizes": ["default", "sm", "lg", "icon", "icon-sm", "icon-lg"],
          "recommended": "variant='ghost' size='sm' for Edit button in card footer"
        }
      },
      {
        "name": "cn",
        "path": "@/shared/lib/utils",
        "reason": "Utility for conditional className merging (twMerge + clsx)",
        "usedIn": []
      },
      {
        "name": "Pencil (lucide-react)",
        "path": "lucide-react",
        "reason": "Standard edit icon - already used in 7+ components for edit actions",
        "usedIn": [],
        "examples": [
          "frontend/src/features/conversation/components/TitleEditor.tsx",
          "frontend/src/features/project-draft/components/ProjectDraftHeader.tsx",
          "frontend/src/features/project-draft/components/ExperimentsSection.tsx"
        ]
      },
      {
        "name": "useRouter",
        "path": "next/navigation",
        "reason": "Next.js 15 App Router navigation hook",
        "usedIn": [],
        "pattern": "const router = useRouter(); router.push('/conversations/{id}')"
      },
      {
        "name": "stopPropagation pattern",
        "path": "n/a",
        "reason": "Prevent card click when clicking button inside card",
        "usedIn": [],
        "pattern": "onClick={(e) => { e.stopPropagation(); ... }}",
        "examples": [
          "frontend/src/features/conversation/components/IdeationQueueCard.tsx:39",
          "frontend/src/features/conversation/components/IdeationQueueRunItem.tsx:23"
        ]
      },
      {
        "name": "formatRelativeTime",
        "path": "@/shared/lib/date-utils",
        "reason": "Date formatting utility (uses date-fns)",
        "usedIn": []
      },
      {
        "name": "Migration pattern: Add column + refresh view",
        "path": "server/database_migrations/versions/0003_manual_seed_columns.py",
        "reason": "Pattern for adding column to conversations and updating conversation_dashboard_view",
        "usedIn": [],
        "pattern": "op.add_column() + op.execute('CREATE OR REPLACE VIEW conversation_dashboard_view AS ...')"
      },
      {
        "name": "CONVERSATION_STATUSES tuple",
        "path": "server/app/services/database/conversations.py",
        "reason": "New constant following PIPELINE_RUN_STATUSES pattern for validation",
        "usedIn": [],
        "pattern": "CONVERSATION_STATUSES = ('draft', 'with_research')"
      },
      {
        "name": "ConversationsMixin update methods",
        "path": "server/app/services/database/conversations.py",
        "reason": "Patterns for update_conversation_title and other update methods",
        "usedIn": [],
        "methods": [
          "update_conversation_title(conversation_id, new_title) -> bool",
          "update_conversation_messages(conversation_id, messages) -> bool"
        ]
      },
      {
        "name": "IdeasMixin.get_idea_by_id",
        "path": "server/app/services/database/ideas.py:368",
        "reason": "Used to lookup conversation_id from idea_id for status update",
        "usedIn": []
      },
      {
        "name": "Transaction pattern with cursor",
        "path": "server/app/services/database/research_pipeline_runs.py:75-112",
        "reason": "Pattern for multi-step operations in same transaction",
        "usedIn": [],
        "pattern": "with self._get_connection() as conn:\n    with conn.cursor() as cursor:\n        cursor.execute(...)\n        conn.commit()"
      }
    ],
    "create": [
      {
        "name": "0013_add_conversation_status.py",
        "path": "server/database_migrations/versions/0013_add_conversation_status.py",
        "reason": "Migration to add status column with default and backfill",
        "status": "pending"
      },
      {
        "name": "update_conversation_status method",
        "path": "server/app/services/database/conversations.py",
        "reason": "New method in ConversationsMixin to update status",
        "status": "pending",
        "signature": "update_conversation_status(self, conversation_id: int, status: str) -> bool"
      },
      {
        "name": "Edit button in IdeationQueueCard footer",
        "path": "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
        "reason": "Add Edit button next to expand/collapse toggle (AC3)",
        "status": "pending"
      },
      {
        "name": "Edit button in InlineIdeaView header",
        "path": "frontend/src/features/conversation/components/InlineIdeaView.tsx",
        "reason": "Add Edit button in metadata header area (AC4)",
        "status": "pending"
      }
    ],
    "extract": []
  },
  "files": {
    "created": [],
    "modified": [],
    "pending": [
      "server/database_migrations/versions/0013_add_conversation_status.py",
      "server/app/models/conversations.py",
      "server/app/api/conversations.py",
      "server/app/services/database/conversations.py",
      "server/app/services/database/research_pipeline_runs.py",
      "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
      "frontend/src/features/conversation/components/InlineIdeaView.tsx"
    ]
  },
  "phases": [
    {
      "id": "classification",
      "agent": "task-classifier",
      "status": "completed",
      "completedAt": "2025-12-08T00:00:00Z"
    },
    {
      "id": "planning",
      "agent": "feature-planner",
      "status": "completed",
      "completedAt": "2025-12-08T18:00:00Z",
      "docsRead": [
        ".agent/README.md",
        ".agent/System/project_architecture.md",
        ".agent/System/server_architecture.md",
        ".agent/System/frontend_architecture.md",
        ".agent/SOP/server_database_migrations.md"
      ],
      "notes": "REVISED: Changed from computed status to stored ENUM column per user request"
    },
    {
      "id": "analysis",
      "agent": "codebase-analyzer",
      "status": "completed",
      "completedAt": "2025-12-08T20:30:00Z",
      "description": "Analyzed existing conversation schema, API patterns, and component structure"
    },
    {
      "id": "architecture",
      "agent": "feature-architecture-expert",
      "status": "completed",
      "completedAt": "2025-12-08T21:00:00Z",
      "description": "SOLID architecture design completed with implementation order and file specifications"
    },
    {
      "id": "tech-guidance",
      "parallel": true,
      "subtasks": [
        {
          "agent": "fastapi-expert",
          "status": "pending",
          "description": "Guide database migration and API endpoint updates"
        },
        {
          "agent": "nextjs-expert",
          "status": "pending",
          "description": "Guide component modifications and routing patterns"
        }
      ]
    },
    {
      "id": "implementation",
      "agent": "feature-executor",
      "status": "pending",
      "description": "Execute database migration, backend changes, and frontend updates"
    },
    {
      "id": "documentation",
      "agent": "documentation-reviewer",
      "status": "pending",
      "description": "Update architecture docs with new status field pattern"
    }
  ],
  "decisions": [
    {
      "phase": "classification",
      "key": "workflow",
      "value": "fullstack-workflow",
      "reason": "Requires database migration, backend API changes, and frontend component updates. Full coordination needed across tech stack."
    },
    {
      "phase": "classification",
      "key": "requiresUserStories",
      "value": false,
      "reason": "Despite being fullstack and user-facing, the scope is well-defined with 3 clear acceptance criteria that map directly to technical tasks. No user journey decomposition needed - file-driven approach is more efficient."
    },
    {
      "phase": "classification",
      "key": "skip-design-expert",
      "value": true,
      "reason": "Edit button is a simple standard UI pattern (button with text). No visual design or animation complexity."
    },
    {
      "phase": "classification",
      "key": "include-fastapi-expert",
      "value": true,
      "reason": "Database schema changes and migration patterns require FastAPI expertise"
    },
    {
      "phase": "classification",
      "key": "include-nextjs-expert",
      "value": true,
      "reason": "Component modifications and routing to /conversation/[id] require Next.js expertise"
    },
    {
      "phase": "planning",
      "key": "architectural-approach",
      "value": "stored-enum-column",
      "reason": "REVISED per user request. User wants a dedicated status column for better status handling. Enables direct queries, explicit state management, and flexibility for future status values.",
      "alternatives": [
        {
          "name": "computed-status-pattern",
          "rejectedWhy": "User explicitly requested stored column for better status control"
        },
        {
          "name": "hybrid-cached-status",
          "rejectedWhy": "Over-engineered for current requirements"
        }
      ]
    },
    {
      "phase": "planning",
      "key": "status-values",
      "value": "draft|with_research",
      "reason": "Two-state ENUM matching user story. 'draft' = initial state, 'with_research' = has launched research"
    },
    {
      "phase": "planning",
      "key": "status-column-type",
      "value": "TEXT with server_default",
      "reason": "PostgreSQL TEXT with server_default follows existing pattern (research_pipeline_runs.status). Python-level validation via CONVERSATION_STATUSES tuple."
    },
    {
      "phase": "planning",
      "key": "status-default",
      "value": "draft",
      "reason": "All new conversations start as 'draft'. Existing conversations without status should default to 'draft' during migration."
    },
    {
      "phase": "planning",
      "key": "status-transition-trigger",
      "value": "application-level",
      "reason": "Update status to 'with_research' in create_research_pipeline_run() method. Application-level logic is easier to maintain than database triggers and matches existing patterns."
    },
    {
      "phase": "planning",
      "key": "edit-button-placement",
      "value": "footer-row",
      "reason": "Place Edit button in footer area next to existing expand/collapse toggle for consistency. Use stopPropagation to prevent card click."
    },
    {
      "phase": "planning",
      "key": "edit-button-icon",
      "value": "Pencil",
      "reason": "Lucide Pencil icon is standard for edit actions, already imported in codebase"
    },
    {
      "phase": "analysis",
      "key": "status-validation-pattern",
      "value": "python-tuple-validation",
      "reason": "Codebase uses Python tuple constants (PIPELINE_RUN_STATUSES) for validation rather than database CHECK constraints. Should follow this pattern for consistency."
    },
    {
      "phase": "analysis",
      "key": "button-styling",
      "value": "ghost-variant-small-size",
      "reason": "Existing card buttons use ghost variant for subtle appearance. Footer buttons should match: variant='ghost' size='sm'"
    },
    {
      "phase": "analysis",
      "key": "migration-numbering",
      "value": "0013",
      "reason": "Latest migration is 0012_substage_completed_events.py, next should be 0013_add_conversation_status.py"
    },
    {
      "phase": "architecture",
      "key": "solid-srp",
      "value": "status-update-in-conversations-mixin",
      "reason": "Status update method belongs in ConversationsMixin (SRP: manages conversation state). ResearchPipelineRunsMixin calls it after creating run."
    },
    {
      "phase": "architecture",
      "key": "solid-ocp",
      "value": "status-values-as-constant",
      "reason": "CONVERSATION_STATUSES tuple allows adding new statuses without modifying validation logic. Open for extension (new values), closed for modification."
    },
    {
      "phase": "architecture",
      "key": "solid-dip",
      "value": "mixin-composition",
      "reason": "DatabaseManager composes mixins. ResearchPipelineRunsMixin can call ConversationsMixin methods via self since both are mixed into DatabaseManager."
    },
    {
      "phase": "architecture",
      "key": "solid-analysis-namedtuple",
      "value": "acceptable-pattern",
      "reason": "NamedTuples are immutable data containers (value objects). Adding a field is data extension, not a SOLID violation. They follow SRP as pure data transfer objects."
    },
    {
      "phase": "architecture",
      "key": "cross-mixin-call-pattern",
      "value": "self-method-call",
      "reason": "ResearchPipelineRunsMixin can call update_conversation_status via self because both mixins are composed into DatabaseManager. No need for StatusManager class."
    },
    {
      "phase": "architecture",
      "key": "transaction-boundary",
      "value": "single-transaction",
      "reason": "Status update and run creation should be in same transaction for atomicity. Use cursor from existing transaction context."
    },
    {
      "phase": "architecture",
      "key": "implementation-order",
      "value": "migration-first",
      "reason": "1. Migration (schema), 2. ConversationsMixin (status method + NamedTuples), 3. Models (Pydantic), 4. API (response conversion), 5. ResearchPipelineRunsMixin (auto-update), 6. Frontend (Edit buttons)"
    }
  ],
  "searches": [
    {
      "pattern": "server/database_migrations/versions/*.py",
      "tool": "glob",
      "results": 12,
      "at": "2025-12-08T18:00:00Z"
    },
    {
      "pattern": "lucide-react",
      "tool": "grep",
      "results": 30,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "useRouter",
      "tool": "grep",
      "results": 19,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "Pencil",
      "tool": "grep",
      "results": 13,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "stopPropagation",
      "tool": "grep",
      "results": 9,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "sa.CheckConstraint",
      "tool": "grep",
      "results": 1,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "class DatabaseManager|def get_conversation_id_by_idea",
      "tool": "grep",
      "results": 1,
      "at": "2025-12-08T21:00:00Z",
      "path": "/Users/jarbasmoraes/code/ae/ae-scientist/AE-Scientist/server/app/services/database"
    }
  ],
  "reviews": {
    "copy": [],
    "queries": []
  },
  "acceptanceCriteria": [
    {
      "id": "AC1",
      "description": "Create a status column for conversations: Draft | With Research (when we have launched research)",
      "technicalRequirements": [
        "Add 'status' TEXT column to conversations table with server_default='draft'",
        "Allowed values: 'draft', 'with_research' (validated in Python via CONVERSATION_STATUSES tuple)",
        "Migration backfills existing conversations: set to 'with_research' if has research runs, else 'draft'",
        "Update conversation_dashboard_view to include status column",
        "Add status field to ConversationResponse model",
        "Add status field to FullConversation and DashboardConversation NamedTuples"
      ]
    },
    {
      "id": "AC2",
      "description": "Auto-update status when research run is created",
      "technicalRequirements": [
        "Add update_conversation_status() method to ConversationsMixin",
        "Add _update_conversation_status_with_cursor() for transaction-safe updates",
        "In create_research_pipeline_run(), lookup conversation_id via idea_id",
        "Call status update within existing transaction (before conn.commit())",
        "Use IdeasMixin.get_idea_by_id() or direct SQL to get conversation_id"
      ]
    },
    {
      "id": "AC3",
      "description": "Have an 'Edit' button in the IdeationQueueCard so I can go to the /conversation/[id] page",
      "technicalRequirements": [
        "Add Edit button with Pencil icon to IdeationQueueCard footer",
        "Button uses router.push to navigate to /conversations/{id}",
        "onClick handler calls e.stopPropagation() to prevent card click",
        "Use Button component with variant='ghost' size='sm'",
        "Style: text-slate-400 hover:text-slate-300"
      ]
    },
    {
      "id": "AC4",
      "description": "Have an 'Edit' button in the InlineIdeaView so I can go to the /conversation/[id] page",
      "technicalRequirements": [
        "Add Edit button in InlineIdeaView header area",
        "Position in the flex row with metadata (after badges)",
        "Button uses router.push to navigate to /conversations/{id}",
        "Use Button component with variant='outline' size='sm'",
        "Include Pencil icon and 'Edit' text"
      ]
    }
  ],
  "architecture": {
    "implementationOrder": [
      {
        "order": 1,
        "file": "server/database_migrations/versions/0013_add_conversation_status.py",
        "type": "create",
        "reason": "Schema must exist before code references it",
        "dependencies": [],
        "solidPrinciples": ["SRP: Migration only handles schema changes"]
      },
      {
        "order": 2,
        "file": "server/app/services/database/conversations.py",
        "type": "modify",
        "reason": "Add CONVERSATION_STATUSES constant, update_conversation_status method, and update NamedTuples",
        "dependencies": ["0013_add_conversation_status.py"],
        "solidPrinciples": ["SRP: ConversationsMixin manages conversation state", "OCP: Status values extensible via tuple constant"]
      },
      {
        "order": 3,
        "file": "server/app/models/conversations.py",
        "type": "modify",
        "reason": "Add status field to ConversationResponse Pydantic model",
        "dependencies": ["conversations.py service"],
        "solidPrinciples": ["SRP: Models define API contracts only"]
      },
      {
        "order": 4,
        "file": "server/app/api/conversations.py",
        "type": "modify",
        "reason": "Update convert_db_to_api_response to include status field",
        "dependencies": ["ConversationResponse model"],
        "solidPrinciples": ["SRP: API layer handles HTTP concerns only"]
      },
      {
        "order": 5,
        "file": "server/app/services/database/research_pipeline_runs.py",
        "type": "modify",
        "reason": "Add status update call in create_research_pipeline_run",
        "dependencies": ["update_conversation_status method"],
        "solidPrinciples": ["SRP: Run creation + side effect (status update)", "DIP: Calls abstraction via self"]
      },
      {
        "order": 6,
        "file": "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
        "type": "modify",
        "reason": "Add Edit button with navigation",
        "dependencies": [],
        "solidPrinciples": ["SRP: Component handles display + user interaction"]
      },
      {
        "order": 7,
        "file": "frontend/src/features/conversation/components/InlineIdeaView.tsx",
        "type": "modify",
        "reason": "Add Edit button with navigation",
        "dependencies": [],
        "solidPrinciples": ["SRP: Component handles display + user interaction"]
      }
    ],
    "interfaces": {
      "CONVERSATION_STATUSES": {
        "type": "tuple",
        "location": "server/app/services/database/conversations.py",
        "definition": "CONVERSATION_STATUSES = ('draft', 'with_research')",
        "purpose": "Validation constant for status values"
      },
      "update_conversation_status": {
        "type": "method",
        "location": "server/app/services/database/conversations.py",
        "signature": "def update_conversation_status(self, conversation_id: int, status: str) -> bool",
        "purpose": "Public method for updating conversation status",
        "validation": "Raises ValueError if status not in CONVERSATION_STATUSES"
      },
      "_update_conversation_status_with_cursor": {
        "type": "method",
        "location": "server/app/services/database/conversations.py",
        "signature": "def _update_conversation_status_with_cursor(self, cursor, conversation_id: int, status: str) -> None",
        "purpose": "Transaction-safe status update for use within existing transactions",
        "validation": "Raises ValueError if status not in CONVERSATION_STATUSES"
      }
    },
    "solidAnalysis": {
      "violations": [],
      "recommendations": [
        {
          "file": "server/app/services/database/research_pipeline_runs.py",
          "observation": "create_research_pipeline_run will have two responsibilities: creating run + updating status",
          "verdict": "ACCEPTABLE",
          "reason": "Status update is a side effect of run creation, not a separate responsibility. They are causally linked. Extracting to StatusManager would over-engineer."
        },
        {
          "file": "server/app/services/database/conversations.py",
          "observation": "NamedTuples (FullConversation, DashboardConversation) are data containers",
          "verdict": "NOT A VIOLATION",
          "reason": "NamedTuples are value objects / DTOs. Adding a field is data structure extension, not responsibility bloat. They have single responsibility: carry data."
        },
        {
          "file": "server/app/api/conversations.py",
          "observation": "convert_db_to_api_response function handles mapping",
          "verdict": "GOOD SRP",
          "reason": "Single responsibility: convert DB NamedTuple to API Pydantic model. Adding status field is natural extension."
        }
      ],
      "refactoringRequired": false
    }
  },
  "currentPhase": "implementation",
  "nextAgent": "fastapi-expert",
  "blockedBy": null
}
