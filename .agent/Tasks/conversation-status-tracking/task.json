{
  "id": "conversation-status-tracking",
  "name": "Conversation Status Tracking",
  "description": "Add status column to conversations table (Draft | With Research) with auto-update when research runs are created, and Edit buttons in IdeationQueueCard and InlineIdeaView to navigate to /conversation/[id] page",
  "created": "2025-12-08T00:00:00Z",
  "lastUpdated": "2025-12-08T20:30:00Z",
  "classification": {
    "type": "fullstack",
    "scope": "single-feature",
    "complexity": "moderate",
    "confidence": "high",
    "requiresUserStories": false,
    "workflow": [
      "feature-planner",
      "codebase-analyzer",
      "feature-architecture-expert",
      "fastapi-expert",
      "nextjs-expert",
      "feature-executor",
      "documentation-reviewer"
    ],
    "reasoning": {
      "type": "User story describes both backend (status column + database migration + auto-update) and frontend (UI updates to 2 components)",
      "scope": "Changes limited to conversation feature - backend schema, service updates, API changes, and 2 frontend components",
      "complexity": "Moderate - requires database migration, backend status update logic, API changes, and coordinated frontend updates",
      "requiresUserStories": "False - file-driven approach is sufficient. While fullstack and user-facing, the scope is contained to a single feature with clear technical requirements (status enum + edit buttons).",
      "workflow": "Full workflow needed due to fullstack nature: database schema changes (migration), backend API updates (FastAPI), frontend component modifications (Next.js), and documentation"
    }
  },
  "techStack": {
    "detected": [
      "nextjs-15",
      "typescript",
      "react-19",
      "fastapi",
      "postgresql",
      "alembic"
    ],
    "versions": {
      "next": "15.4.8",
      "react": "19.1.2",
      "fastapi": "0.115.0",
      "typescript": "5.x"
    }
  },
  "docsConsulted": {
    "project": [
      ".agent/README.md",
      ".agent/System/project_architecture.md",
      ".agent/System/server_architecture.md",
      ".agent/System/frontend_architecture.md",
      ".agent/SOP/server_database_migrations.md"
    ],
    "external": [],
    "existingFeatures": [
      "server/app/models/conversations.py",
      "server/app/api/conversations.py",
      "server/app/services/database/conversations.py",
      "server/app/services/database/research_pipeline_runs.py",
      "server/database_migrations/versions/0003_manual_seed_columns.py",
      "server/database_migrations/versions/0012_substage_completed_events.py",
      "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
      "frontend/src/features/conversation/components/InlineIdeaView.tsx",
      "frontend/src/features/conversation/types/ideation-queue.types.ts"
    ]
  },
  "assets": {
    "reuse": [
      {
        "name": "Button",
        "path": "@/shared/components/ui/button",
        "reason": "shadcn Button component - use variant='ghost' for Edit button",
        "usedIn": [],
        "patterns": {
          "variants": ["default", "destructive", "outline", "secondary", "ghost", "link"],
          "sizes": ["default", "sm", "lg", "icon", "icon-sm", "icon-lg"],
          "recommended": "variant='ghost' size='sm' for Edit button in card footer"
        }
      },
      {
        "name": "cn",
        "path": "@/shared/lib/utils",
        "reason": "Utility for conditional className merging (twMerge + clsx)",
        "usedIn": []
      },
      {
        "name": "Pencil (lucide-react)",
        "path": "lucide-react",
        "reason": "Standard edit icon - already used in 7+ components for edit actions",
        "usedIn": [],
        "examples": [
          "frontend/src/features/conversation/components/TitleEditor.tsx",
          "frontend/src/features/project-draft/components/ProjectDraftHeader.tsx",
          "frontend/src/features/project-draft/components/ExperimentsSection.tsx"
        ]
      },
      {
        "name": "useRouter",
        "path": "next/navigation",
        "reason": "Next.js 15 App Router navigation hook",
        "usedIn": [],
        "pattern": "const router = useRouter(); router.push('/conversations/{id}')"
      },
      {
        "name": "stopPropagation pattern",
        "path": "n/a",
        "reason": "Prevent card click when clicking button inside card",
        "usedIn": [],
        "pattern": "onClick={(e) => { e.stopPropagation(); ... }}",
        "examples": [
          "frontend/src/features/conversation/components/IdeationQueueCard.tsx:39",
          "frontend/src/features/conversation/components/IdeationQueueRunItem.tsx:23"
        ]
      },
      {
        "name": "formatRelativeTime",
        "path": "@/shared/lib/date-utils",
        "reason": "Date formatting utility (uses date-fns)",
        "usedIn": []
      },
      {
        "name": "Migration pattern: Add column + refresh view",
        "path": "server/database_migrations/versions/0003_manual_seed_columns.py",
        "reason": "Pattern for adding column to conversations and updating conversation_dashboard_view",
        "usedIn": [],
        "pattern": "op.add_column() + op.execute('CREATE OR REPLACE VIEW conversation_dashboard_view AS ...')"
      },
      {
        "name": "Migration pattern: Table creation",
        "path": "server/database_migrations/versions/0012_substage_completed_events.py",
        "reason": "Pattern for creating tables with indexes",
        "usedIn": []
      },
      {
        "name": "CHECK constraint pattern",
        "path": "server/database_migrations/versions/0001_initial_schema.py:194",
        "reason": "Pattern for CHECK constraint on status columns",
        "usedIn": [],
        "pattern": "sa.CheckConstraint(\"role IN ('user', 'assistant')\", name=\"chat_messages_role_check\")"
      },
      {
        "name": "Status column pattern (TEXT with validation)",
        "path": "server/database_migrations/versions/0005_research_pipeline_runs.py:34",
        "reason": "research_pipeline_runs.status uses TEXT with default, validated in Python",
        "usedIn": [],
        "pattern": "sa.Column('status', sa.Text(), nullable=False, server_default='pending')"
      },
      {
        "name": "PIPELINE_RUN_STATUSES tuple",
        "path": "server/app/services/database/research_pipeline_runs.py:14",
        "reason": "Pattern for defining allowed status values as tuple constant",
        "usedIn": [],
        "pattern": "PIPELINE_RUN_STATUSES = ('pending', 'running', 'failed', 'completed')"
      },
      {
        "name": "ConversationsMixin update methods",
        "path": "server/app/services/database/conversations.py",
        "reason": "Patterns for update_conversation_title and other update methods",
        "usedIn": [],
        "methods": [
          "update_conversation_title(conversation_id, new_title) -> bool",
          "update_conversation_messages(conversation_id, messages) -> bool"
        ]
      },
      {
        "name": "FullConversation NamedTuple",
        "path": "server/app/services/database/conversations.py:37",
        "reason": "Database layer NamedTuple - needs status field added",
        "usedIn": []
      },
      {
        "name": "DashboardConversation NamedTuple",
        "path": "server/app/services/database/conversations.py:56",
        "reason": "Dashboard view NamedTuple - needs status field added",
        "usedIn": []
      },
      {
        "name": "ConversationResponse Pydantic model",
        "path": "server/app/models/conversations.py:94",
        "reason": "API response model - needs status field added",
        "usedIn": []
      },
      {
        "name": "ResearchPipelineRunsMixin.create_research_pipeline_run",
        "path": "server/app/services/database/research_pipeline_runs.py:61",
        "reason": "Method where status update logic will be added (AC2)",
        "usedIn": [],
        "notes": "Uses transaction with conn.cursor() and conn.commit()"
      },
      {
        "name": "Transaction pattern with cursor",
        "path": "server/app/services/database/research_pipeline_runs.py:75-112",
        "reason": "Pattern for multi-step operations in same transaction",
        "usedIn": [],
        "pattern": "with self._get_connection() as conn:\n    with conn.cursor() as cursor:\n        cursor.execute(...)\n        # more operations\n        conn.commit()"
      }
    ],
    "create": [
      {
        "name": "0013_add_conversation_status.py",
        "path": "server/database_migrations/versions/0013_add_conversation_status.py",
        "reason": "Migration to add status column with CHECK constraint and backfill",
        "status": "pending",
        "dependencies": [
          "Migration pattern: Add column + refresh view",
          "CHECK constraint pattern",
          "Status column pattern (TEXT with validation)"
        ]
      },
      {
        "name": "update_conversation_status method",
        "path": "server/app/services/database/conversations.py",
        "reason": "New method in ConversationsMixin to update status",
        "status": "pending",
        "signature": "update_conversation_status(self, conversation_id: int, status: str) -> bool",
        "dependencies": [
          "ConversationsMixin update methods"
        ]
      },
      {
        "name": "Edit button in IdeationQueueCard footer",
        "path": "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
        "reason": "Add Edit button next to expand/collapse toggle (AC3)",
        "status": "pending",
        "dependencies": [
          "Button",
          "Pencil (lucide-react)",
          "useRouter",
          "stopPropagation pattern"
        ]
      },
      {
        "name": "Edit button in InlineIdeaView header",
        "path": "frontend/src/features/conversation/components/InlineIdeaView.tsx",
        "reason": "Add Edit button in metadata header area (AC4)",
        "status": "pending",
        "dependencies": [
          "Button",
          "Pencil (lucide-react)",
          "useRouter"
        ]
      }
    ],
    "extract": []
  },
  "files": {
    "created": [],
    "modified": [],
    "pending": [
      "server/database_migrations/versions/0013_add_conversation_status.py",
      "server/app/models/conversations.py",
      "server/app/api/conversations.py",
      "server/app/services/database/conversations.py",
      "server/app/services/database/research_pipeline_runs.py",
      "frontend/src/features/conversation/components/IdeationQueueCard.tsx",
      "frontend/src/features/conversation/components/InlineIdeaView.tsx"
    ]
  },
  "phases": [
    {
      "id": "classification",
      "agent": "task-classifier",
      "status": "completed",
      "completedAt": "2025-12-08T00:00:00Z"
    },
    {
      "id": "planning",
      "agent": "feature-planner",
      "status": "completed",
      "completedAt": "2025-12-08T18:00:00Z",
      "docsRead": [
        ".agent/README.md",
        ".agent/System/project_architecture.md",
        ".agent/System/server_architecture.md",
        ".agent/System/frontend_architecture.md",
        ".agent/SOP/server_database_migrations.md"
      ],
      "notes": "REVISED: Changed from computed status to stored ENUM column per user request"
    },
    {
      "id": "analysis",
      "agent": "codebase-analyzer",
      "status": "completed",
      "completedAt": "2025-12-08T20:30:00Z",
      "description": "Analyzed existing conversation schema, API patterns, and component structure"
    },
    {
      "id": "architecture",
      "agent": "feature-architecture-expert",
      "status": "pending",
      "description": "Design status enum, migration strategy, API changes, and UI patterns"
    },
    {
      "id": "tech-guidance",
      "parallel": true,
      "subtasks": [
        {
          "agent": "fastapi-expert",
          "status": "pending",
          "description": "Guide database migration and API endpoint updates"
        },
        {
          "agent": "nextjs-expert",
          "status": "pending",
          "description": "Guide component modifications and routing patterns"
        }
      ]
    },
    {
      "id": "implementation",
      "agent": "feature-executor",
      "status": "pending",
      "description": "Execute database migration, backend changes, and frontend updates"
    },
    {
      "id": "documentation",
      "agent": "documentation-reviewer",
      "status": "pending",
      "description": "Update architecture docs with new status field pattern"
    }
  ],
  "decisions": [
    {
      "phase": "classification",
      "key": "workflow",
      "value": "fullstack-workflow",
      "reason": "Requires database migration, backend API changes, and frontend component updates. Full coordination needed across tech stack."
    },
    {
      "phase": "classification",
      "key": "requiresUserStories",
      "value": false,
      "reason": "Despite being fullstack and user-facing, the scope is well-defined with 3 clear acceptance criteria that map directly to technical tasks. No user journey decomposition needed - file-driven approach is more efficient."
    },
    {
      "phase": "classification",
      "key": "skip-design-expert",
      "value": true,
      "reason": "Edit button is a simple standard UI pattern (button with text). No visual design or animation complexity."
    },
    {
      "phase": "classification",
      "key": "include-fastapi-expert",
      "value": true,
      "reason": "Database schema changes and migration patterns require FastAPI expertise"
    },
    {
      "phase": "classification",
      "key": "include-nextjs-expert",
      "value": true,
      "reason": "Component modifications and routing to /conversation/[id] require Next.js expertise"
    },
    {
      "phase": "planning",
      "key": "architectural-approach",
      "value": "stored-enum-column",
      "reason": "REVISED per user request. User wants a dedicated status column for better status handling. Enables direct queries, explicit state management, and flexibility for future status values.",
      "alternatives": [
        {
          "name": "computed-status-pattern",
          "rejectedWhy": "User explicitly requested stored column for better status control"
        },
        {
          "name": "hybrid-cached-status",
          "rejectedWhy": "Over-engineered for current requirements"
        }
      ]
    },
    {
      "phase": "planning",
      "key": "status-values",
      "value": "draft|with_research",
      "reason": "Two-state ENUM matching user story. 'draft' = initial state, 'with_research' = has launched research"
    },
    {
      "phase": "planning",
      "key": "status-column-type",
      "value": "TEXT with CHECK constraint",
      "reason": "PostgreSQL TEXT with CHECK constraint is more flexible than ENUM type for future additions. Pattern consistent with existing status columns (e.g., research_pipeline_runs.status)"
    },
    {
      "phase": "planning",
      "key": "status-default",
      "value": "draft",
      "reason": "All new conversations start as 'draft'. Existing conversations without status should default to 'draft' during migration."
    },
    {
      "phase": "planning",
      "key": "status-transition-trigger",
      "value": "application-level",
      "reason": "Update status to 'with_research' in create_research_pipeline_run() method. Application-level logic is easier to maintain than database triggers and matches existing patterns."
    },
    {
      "phase": "planning",
      "key": "edit-button-placement",
      "value": "footer-row",
      "reason": "Place Edit button in footer area next to existing expand/collapse toggle for consistency. Use stopPropagation to prevent card click."
    },
    {
      "phase": "planning",
      "key": "edit-button-icon",
      "value": "Pencil",
      "reason": "Lucide Pencil icon is standard for edit actions, already imported in codebase"
    },
    {
      "phase": "analysis",
      "key": "status-validation-pattern",
      "value": "python-tuple-validation",
      "reason": "Codebase uses Python tuple constants (PIPELINE_RUN_STATUSES) for validation rather than database CHECK constraints. Should follow this pattern for consistency."
    },
    {
      "phase": "analysis",
      "key": "button-styling",
      "value": "ghost-variant-small-size",
      "reason": "Existing card buttons use ghost variant for subtle appearance. Footer buttons should match: variant='ghost' size='sm'"
    },
    {
      "phase": "analysis",
      "key": "migration-numbering",
      "value": "0013",
      "reason": "Latest migration is 0012_substage_completed_events.py, next should be 0013_add_conversation_status.py"
    }
  ],
  "searches": [
    {
      "pattern": "server/database_migrations/versions/*.py",
      "tool": "glob",
      "results": 12,
      "at": "2025-12-08T18:00:00Z"
    },
    {
      "pattern": "lucide-react",
      "tool": "grep",
      "results": 30,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "useRouter",
      "tool": "grep",
      "results": 19,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "Pencil",
      "tool": "grep",
      "results": 13,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "stopPropagation",
      "tool": "grep",
      "results": 9,
      "at": "2025-12-08T20:30:00Z"
    },
    {
      "pattern": "sa.CheckConstraint",
      "tool": "grep",
      "results": 1,
      "at": "2025-12-08T20:30:00Z"
    }
  ],
  "reviews": {
    "copy": [],
    "queries": []
  },
  "acceptanceCriteria": [
    {
      "id": "AC1",
      "description": "Create a status column for conversations: Draft | With Research (when we have launched research)",
      "technicalRequirements": [
        "Add 'status' TEXT column to conversations table with CHECK constraint",
        "Default value: 'draft'",
        "Allowed values: 'draft', 'with_research'",
        "Migration backfills existing conversations: set to 'with_research' if has research runs, else 'draft'",
        "Update conversation_dashboard_view to include status column",
        "Add status field to ConversationResponse model",
        "Add status field to FullConversation and DashboardConversation NamedTuples"
      ]
    },
    {
      "id": "AC2",
      "description": "Auto-update status when research run is created",
      "technicalRequirements": [
        "In create_research_pipeline_run(), update parent conversation status to 'with_research'",
        "Add update_conversation_status() method to ConversationsMixin",
        "Lookup conversation_id via idea_id when creating run",
        "Transaction safety: status update should be in same transaction as run creation"
      ]
    },
    {
      "id": "AC3",
      "description": "Have an 'Edit' button in the IdeationQueueCard so I can go to the /conversation/[id] page",
      "technicalRequirements": [
        "Add Edit button with Pencil icon to IdeationQueueCard footer",
        "Button uses router.push to navigate to /conversations/{id}",
        "onClick handler calls e.stopPropagation() to prevent card click",
        "Use consistent styling: variant='ghost' size='sm' text-slate-400 hover:text-slate-300",
        "Button text: 'Edit' with Pencil icon"
      ]
    },
    {
      "id": "AC4",
      "description": "Have an 'Edit' button in the InlineIdeaView so I can go to the /conversation/[id] page",
      "technicalRequirements": [
        "Add Edit button in InlineIdeaView header area",
        "Position in the flex row with metadata (after badges)",
        "Button uses router.push to navigate to /conversations/{id}",
        "Use shadcn Button component with variant='ghost' or 'outline'",
        "Include Pencil icon and 'Edit' text"
      ]
    }
  ],
  "currentPhase": "architecture",
  "nextAgent": "feature-architecture-expert",
  "blockedBy": null
}
